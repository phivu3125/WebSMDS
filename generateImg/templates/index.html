<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Banknote Style Generator</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Arial;
        max-width:1200px;
        margin:30px auto;
        padding: 0 20px;
      }
      .header {
        text-align: center;
        margin-bottom: 40px;
      }
      .upload-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
      }
      .banknote-selection {
        margin: 30px 0;
      }
      .banknote-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .banknote-card {
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
      }
      .banknote-card:hover {
        border-color: #007bff;
        box-shadow: 0 4px 12px rgba(0,123,255,0.15);
      }
      .banknote-card.selected {
        border-color: #007bff;
        background: #e7f3ff;
      }
      .banknote-preview {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 10px;
      }
      .banknote-title {
        font-weight: bold;
        font-size: 18px;
        margin-bottom: 8px;
      }
      .banknote-description {
        font-size: 14px;
        color: #666;
        line-height: 1.4;
      }
      .generate-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        margin: 20px 0;
      }
      .generate-button:hover:not(:disabled) {
        background: #0056b3;
      }
      .generate-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .progress-section {
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        display: none;
      }
      .progress-step {
        display: flex;
        align-items: center;
        margin: 10px 0;
      }
      .step-indicator {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-weight: bold;
      }
      .step-indicator.active {
        background: #007bff;
        color: white;
      }
      .step-indicator.completed {
        background: #28a745;
        color: white;
      }
      .results-section {
        margin-top: 30px;
      }
      .result-container {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .result-step {
        margin-bottom: 20px;
      }
      .result-step h4 {
        color: #007bff;
        margin-bottom: 10px;
      }
      .result-image {
        max-width: 100%;
        max-height: 400px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin: 10px 0;
      }
      .logs {
        background: #111;
        color: #eee;
        padding: 15px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 20px;
      }
      .error {
        color: #dc3545;
        background: #f8d7da;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Banknote Style Generator</h1>
      <p>Transform your photo into various Vietnamese banknote styles</p>
    </div>

    <div class="upload-section">
      <h3>Step 1: Upload Your Photo</h3>
      <form id="form">
        <div>
          <label><strong>Your Photo (required)</strong></label><br>
          <input type="file" name="input_image" accept="image/*" required />
        </div>
      </form>
    </div>

    <div class="banknote-selection">
      <h3>Step 2: Choose Banknote Style</h3>
      <div class="banknote-grid">
        {% for banknote in banknotes %}
        <div class="banknote-card" data-banknote-id="{{ banknote.id }}">
          <img src="/samples/{{ banknote.sample_image }}" alt="{{ banknote.name }}" class="banknote-preview">
          <div class="banknote-title">{{ banknote.name }}</div>
          <div class="banknote-description">{{ banknote.style_description }}</div>
        </div>
        {% endfor %}
      </div>
    </div>

    <div style="text-align: center;">
      <button class="generate-button" id="generateBtn" disabled>Generate Banknote Style</button>
    </div>

    <div class="progress-section" id="progressSection">
      <h4>Generation Progress</h4>
      <div class="progress-step">
        <div class="step-indicator" id="step1Indicator">1</div>
        <span>Applying banknote style to your photo...</span>
      </div>
      <div class="progress-step">
        <div class="step-indicator" id="step2Indicator">2</div>
        <span>Integrating styled photo into banknote...</span>
      </div>
    </div>

    <div class="results-section">
      <div id="results"></div>
      <div class="logs" id="logs" style="display: none;">No run yet.</div>
    </div>

    <script>
      const form = document.getElementById('form');
      const generateBtn = document.getElementById('generateBtn');
      const logs = document.getElementById('logs');
      const results = document.getElementById('results');
      const progressSection = document.getElementById('progressSection');
      const step1Indicator = document.getElementById('step1Indicator');
      const step2Indicator = document.getElementById('step2Indicator');

      let selectedBanknote = null;

      // Banknote selection handling
      document.querySelectorAll('.banknote-card').forEach(card => {
        card.addEventListener('click', () => {
          // Remove previous selection
          document.querySelectorAll('.banknote-card').forEach(c => c.classList.remove('selected'));

          // Add selection to clicked card
          card.classList.add('selected');
          selectedBanknote = card.dataset.banknoteId;

          // Enable generate button if file is selected
          checkGenerateButton();
        });
      });

      // File input handling
      form.addEventListener('change', checkGenerateButton);

      function checkGenerateButton() {
        const fileInput = form.querySelector('input[type="file"]');
        const hasFile = fileInput.files.length > 0;
        const hasBanknote = selectedBanknote !== null;

        generateBtn.disabled = !(hasFile && hasBanknote);
      }

      generateBtn.addEventListener('click', async () => {
        if (generateBtn.disabled) return;

        const fileInput = form.querySelector('input[type="file"]');
        const data = new FormData();
        data.append('input_image', fileInput.files[0]);
        data.append('banknote_choice', selectedBanknote);

        // Reset UI
        results.innerHTML = '';
        logs.textContent = 'Starting generation...';
        logs.style.display = 'block';
        progressSection.style.display = 'block';

        // Reset progress indicators
        step1Indicator.className = 'step-indicator active';
        step2Indicator.className = 'step-indicator';

        generateBtn.disabled = true;
        generateBtn.textContent = 'Generating...';

        try {
          const res = await fetch('/run', { method: 'POST', body: data });
          const json = await res.json();

          if (json.error) {
            results.innerHTML = `<div class="error">Error: ${json.error}</div>`;
            logs.textContent = `Error: ${json.error}\n\nSTDOUT:\n${json.stdout || ''}\n\nSTDERR:\n${json.stderr || ''}`;
          } else {
            // Update progress
            step1Indicator.className = 'step-indicator completed';
            step2Indicator.className = 'step-indicator completed';

            // Display results
            logs.textContent = `Status: ${res.status}\nReturn code: ${json.returncode}\n\nSTDOUT:\n${json.stdout}\n\nSTDERR:\n${json.stderr}`;

            if (json.step_outputs && json.step_outputs.step1.length > 0) {
              const step1Container = document.createElement('div');
              step1Container.className = 'result-container';
              step1Container.innerHTML = `
                <div class="result-step">
                  <h4>Step 1: Styled Portrait</h4>
                  <img src="${json.step_outputs.step1[0]}" alt="Styled portrait" class="result-image">
                </div>
              `;
              results.appendChild(step1Container);
            }

            if (json.step_outputs && json.step_outputs.step2.length > 0) {
              const step2Container = document.createElement('div');
              step2Container.className = 'result-container';
              step2Container.innerHTML = `
                <div class="result-step">
                  <h4>Step 2: Final Banknote (${json.banknote_used || 'Unknown'})</h4>
                  <img src="${json.step_outputs.step2[0]}" alt="Final banknote" class="result-image">
                </div>
              `;
              results.appendChild(step2Container);
            } else {
              results.innerHTML = '<div class="error">No output images generated.</div>';
            }
          }
        } catch (err) {
          results.innerHTML = `<div class="error">Network Error: ${err.toString()}</div>`;
          logs.textContent = 'Network Error: ' + err.toString();
        } finally {
          generateBtn.disabled = false;
          generateBtn.textContent = 'Generate Banknote Style';
        }
      });
    </script>
  </body>
</html>